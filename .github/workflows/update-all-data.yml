name: Update All Package Data

on:
  schedule:
    # Run on the 1st of every month at 04:00 UTC
    - cron: '0 4 1 * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

jobs:
  update-all-data:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Increase timeout for comprehensive updates

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Authenticate to Google Cloud (if deployment needed)
      if: github.event_name == 'workflow_dispatch'
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK (if deployment needed)
      if: github.event_name == 'workflow_dispatch'
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: melodic-zoo-458222-s6

    - name: Update all CRAN data
      run: |
        echo "📦 Updating CRAN package list..."
        npm run update-packages

        echo "📝 Updating CRAN package descriptions..."
        node scripts/fetch-package-descriptions.js || echo "Descriptions update failed (non-critical)"

        echo "👥 Updating CRAN author data..."
        node scripts/fetch-author-data-fast.js || echo "Author data update failed (non-critical)"

    - name: Update all Bioconductor data
      run: |
        echo "🧬 Updating Bioconductor packages..."
        npm run update-bioconductor

        echo "📊 Updating Bioconductor statistics..."
        npm run update-bioc-stats || echo "Bioconductor stats update failed (non-critical)"

    - name: Verify all data files
      run: |
        echo "🔍 Verifying all data files..."
        for file in "data/cran-packages.json" "data/cran-descriptions.json" "data/cran-authors.json" "data/bioconductor-packages.json" "data/bioconductor-package-index.json" "data/bioconductor-stats.json" "data/bioconductor-index.json"; do
          if [ -f "$file" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            echo "✅ Found: $file (Size: $SIZE)"
          else
            echo "⚠️ Missing: $file"
          fi
        done

    - name: Commit all updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add all data files
        git add data/*.json data/*.tab 2>/dev/null || true

        # Check if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Get package counts
          CRAN_COUNT=$(grep -o '"[^"]*"' data/cran-packages.json | wc -l)
          BIOC_COUNT=$(grep -c '"name":' data/bioconductor-packages.json || echo "0")

          git commit -m "Monthly comprehensive data update

        📦 CRAN: $CRAN_COUNT packages
        🧬 Bioconductor: $BIOC_COUNT packages

        🤖 Automated monthly update

        Co-Authored-By: GitHub Actions <noreply@github.com>"
        fi

    - name: Push changes
      run: |
        if ! git diff --quiet origin/main; then
          git push origin main
          echo "✅ Changes pushed to repository"
        else
          echo "ℹ️ No changes to push"
        fi

    - name: Deploy to Google App Engine (manual trigger only)
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
      run: |
        echo "🚀 Deploying to Google App Engine..."
        gcloud app deploy --quiet --project=melodic-zoo-458222-s6

    - name: Summary
      run: |
        echo "## 📊 Comprehensive Data Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 Package Counts" >> $GITHUB_STEP_SUMMARY
        CRAN_COUNT=$(grep -o '"[^"]*"' data/cran-packages.json | wc -l)
        BIOC_COUNT=$(grep -c '"name":' data/bioconductor-packages.json || echo "0")
        echo "- **CRAN packages**: $CRAN_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- **Bioconductor packages**: $BIOC_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📂 Data Files Updated" >> $GITHUB_STEP_SUMMARY
        for file in data/*.json data/*.tab; do
          if [ -f "$file" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            echo "- ✅ \`$(basename $file)\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📅 **Last updated**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "🌐 **Live app**: [https://melodic-zoo-458222-s6.uc.r.appspot.com](https://melodic-zoo-458222-s6.uc.r.appspot.com)" >> $GITHUB_STEP_SUMMARY